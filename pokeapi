#pokeapi
#pulls pokemon: id, name, moves, types, dex entry from pokeapi
#written by: Rich Erskine

import pymongo
import requests
import sys
non_bmp_map=dict.fromkeys(range(0x10000, sys.maxunicode+1), 0xfffd)

#connecting to Mongodb and making database + col
myclient = pymongo.MongoClient('mongodb://localhost:27017/')

mydb = myclient['redpokedex']

mycol = mydb["firstgen"]
mycol.drop()
mycol = mydb["firstgen"]

#need 2 urls to connect to the pokemon and dex entries
url = "https://pokeapi.co/api/v2/pokemon/"
url2 = "https://pokeapi.co/api/v2/pokemon-species/"

#iterator through pokemon that start at 1
i=1
poketype = ""
pokemoves= ""

#this is the first generation pokemon and we are only gathering 151
while i < 152:
    url += str(i)
    url += "/"
    url2 += str(i)
    url2 += "/"

    #first request is for the pokemon data
    response = requests.get(url)
    data = response.json()

    pokeid = data['id']
    pokename = data['name']

    #type and moves are arrays so we need to break them down
    for j in data['types']:
        x= j['type']['name'].translate(non_bmp_map)
        poketype += x + "\n"
        
    for k in data['moves']:
        p= k['move']['name'].translate(non_bmp_map)
        pokemoves += p + "\n"

    #changing url to dex entry data
    response = requests.get(url2)
    data = response.json()
    
    pokedex = data['flavor_text_entries'][0]['flavor_text']

    #input data into database
    myentry = { "id": pokeid, "name": pokename, "types": poketype, 
                "moves": pokemoves, "pokedexentry": pokedex }
    x = mycol.insert_one(myentry)

    #reset/increment
    url = "https://pokeapi.co/api/v2/pokemon/"
    url2 = "https://pokeapi.co/api/v2/pokemon-species/"
    i+=1
